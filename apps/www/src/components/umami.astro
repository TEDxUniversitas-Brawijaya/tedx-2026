---
type TrackConfig = {
  autoTrack?: boolean;
  hostUrl?: string;
  domains?: string[];
  tag?: string;
  excludeSearch?: boolean;
  excludeHash?: boolean;
  doNotTrack?: boolean;
  beforeSendHandler?: string | null;
  withPartytown?: boolean;
};

export type Props = {
  websiteId: string;
  scriptSrc?: string;
};

const { websiteId, scriptSrc = "https://cloud.umami.is/script.js" } =
  Astro.props;

const defaultConfig: TrackConfig = {
  autoTrack: true,
  hostUrl: "https://cloud.umami.is",
  domains: ["tedxuniversitasbrawijaya.com", "www.tedxuniversitasbrawijaya.com"],
  tag: "site",
  excludeSearch: false,
  excludeHash: false,
  doNotTrack: false,
  beforeSendHandler: null,
};
---

<script>
  const mode = import.meta.env.MODE;
  if (mode === "development") {
    localStorage.setItem("umami.disabled", "1");
  }
</script>

<script
  defer
  src={scriptSrc}
  data-website-id={websiteId}
  is:inline
  data-auto-track={defaultConfig.autoTrack ? "true" : "false"}
  data-host-url={defaultConfig.hostUrl}
  data-domains={defaultConfig.domains?.join(",")}
  data-tag={defaultConfig.tag}
  data-exclude-search={defaultConfig.excludeSearch ? "true" : "false"}
  data-exclude-hash={defaultConfig.excludeHash ? "true" : "false"}
  data-do-not-track={defaultConfig.doNotTrack ? "true" : "false"}
  data-before-send={defaultConfig.beforeSendHandler}
  data-astro-rerun="false"
>
  const script = document.currentScript;

  const viewTransitionsEnabled = document.querySelector<HTMLMetaElement>(
    "meta[name='astro-view-transitions-enabled']"
  )?.content;
  if (viewTransitionsEnabled === "true") {
    script.setAttribute("data-astro-rerun", "true");
  }
</script>

<script>
  const setupOutboundLinkTracking = () => {
    const eventName = "outbound-link-click";
    const anchors = document.querySelectorAll("a");
    const currentHost = window.location.host;

    for (const anchor of anchors) {
      const { host, href } = anchor;

      if (host === currentHost) {
        continue; // Skip internal links
      }

      if (anchor.hasAttribute("data-umami-event")) {
        continue; // Skip if already has tracking (e.g., content-click)
      }

      anchor.setAttribute("data-umami-event", eventName);
      anchor.setAttribute("data-umami-event-url", href);
    }
  };

  setupOutboundLinkTracking();
</script>
